/* Simple Modal 1.2, (c) 2011 Marco Dellâ€™Anna <http://www.plasm.it>, MIT-style license */
var SimpleModal=new Class({Implements:[Options],request:null,buttons:[],options:{onAppend:Function,onShow:Function,onHide:Function,offsetTop:null,overlayOpacity:.3,overlayColor:"#000000",width:400,draggable:!0,keyEsc:!0,overlayClick:!0,closeButton:!0,hideHeader:!1,hideFooter:!1,lightboxExcessWidth:40,lightboxExcessHeight:120,btn_ok:"OK",btn_cancel:"Cancel",template:'<div class="simple-modal-header"><h1>{_TITLE_}</h1></div><div class="simple-modal-body"><div class="contents">{_CONTENTS_}</div></div><div class="simple-modal-footer"></div>'},initialize:function(t){this.setOptions(t)},show:function(t){switch(t||(t={}),this._overlay("show"),t.model){case"confirm":this.addButton(this.options.btn_ok,"btn primary btn-margin",function(){try{t.callback()}catch(e){}this.hide()}),this.addButton(this.options.btn_cancel,"btn secondary");var e=this._drawWindow(t);this._addEscBehaviour();break;case"modal":var e=this._drawWindow(t);this._addEscBehaviour();break;case"modal-ajax":var e=this._drawWindow(t);this._loadContents({url:t.param.url||"",onRequestComplete:t.param.onRequestComplete||Function});break;default:this.addButton(this.options.btn_ok,"btn primary");var e=this._drawWindow(t);this._addEscBehaviour()}if(e.setStyles({width:Math.min(this.options.width,window.getCoordinates().width-20)}),this.options.hideHeader&&e.addClass("hide-header"),this.options.hideFooter&&e.addClass("hide-footer"),this.options.closeButton&&this._addCloseButton(),this.options.draggable){var i=e.getElement(".simple-modal-header");new Drag(e,{handle:i}),i.setStyle("cursor","move"),e.addClass("draggable")}this._display()},hide:function(){try{"object"==typeof this.request&&this.request.cancel()}catch(t){}this._overlay("hide")},_drawWindow:function(t){var e=new Element("div#simple-modal",{"class":"simple-modal"});e.inject($$("body")[0]);var i=this._template(this.options.template,{_TITLE_:t.title||"Untitled",_CONTENTS_:t.contents||""});return e.set("html",i),this._injectAllButtons(),this.options.onAppend(),e},addButton:function(t,e,i){var o=new Element("a",{title:t,text:t,"class":e,events:{click:(i||this.hide).bind(this)}});return this.buttons.push(o),o},_injectAllButtons:function(){this.buttons.each(function(t){t.inject($("simple-modal").getElement(".simple-modal-footer"))})},_addCloseButton:function(){var t=new Element("a",{"class":"close",href:"#",html:"x"});return t.inject($("simple-modal"),"top"),t.addEvent("click",function(t){t&&t.stop(),this.hide()}.bind(this)),t},_overlay:function(t,e){switch(t){case"show":this._overlay("hide",!0);var i=new Element("div",{id:"simple-modal-overlay"});i.inject($$("body")[0]),i.setStyle("background-color",this.options.overlayColor),i.fade("hide").fade(this.options.overlayOpacity),this.options.overlayClick&&i.addEvent("click",function(t){t&&t.stop(),this.hide()}.bind(this)),this.__resize=this._display.bind(this),window.addEvent("resize",this.__resize),this.options.onShow(),window.fireEvent("sm_show");break;case"hide":window.removeEvent("resize",this._display),this.options.keyEsc&&window.removeEvent("keydown",this._removeSM);try{$("simple-modal-overlay").destroy()}catch(o){}try{$("simple-modal").destroy()}catch(o){}e||(this.options.onHide(),window.fireEvent("sm_hide"))}},_loadContents:function(param){$("simple-modal").addClass("loading");var re=new RegExp(/([^\/\\]+)\.(jpg|png|gif)$/i);if(param.url.match(re)){$("simple-modal").addClass("hide-footer"),$("simple-modal-overlay").removeEvents();var images=[param.url];new Asset.images(images,{onProgress:function(){immagine=this},onComplete:function(){try{$("simple-modal").removeClass("loading");var t=$("simple-modal").getElement(".contents"),e=t.getStyle("padding").split(" "),i=immagine.get("width").toInt()+(e[1].toInt()+e[3].toInt()),o=immagine.get("height").toInt(),s=this._scaleImage(i,o);i=s.width,o=s.height;{new Fx.Tween($("simple-modal"),{duration:"normal",transition:"sine:out",link:"cancel",property:"width"}).start($("simple-modal").getCoordinates().width,i),new Fx.Tween(t,{duration:"normal",transition:"sine:out",link:"cancel",property:"height"}).start(t.getCoordinates().height,o).chain(function(){immagine.inject($("simple-modal").getElement(".contents").empty()).fade("hide").setStyles({width:i,height:o}).fade("in"),this._display(),this._addEscBehaviour()}.bind(this)),new Fx.Tween($("simple-modal"),{duration:"normal",transition:"sine:out",link:"cancel",property:"left"}).start($("simple-modal").getCoordinates().left,(window.getCoordinates().width-i)/2)}}catch(n){}}.bind(this)})}else this.request=new Request.HTML({evalScripts:!1,url:param.url,method:"get",onRequest:function(){},onSuccess:function(responseTree,responseElements,responseHTML,responseJavaScript){$("simple-modal").removeClass("loading"),$("simple-modal").getElement(".contents").set("html",responseHTML),param.onRequestComplete(),eval(responseJavaScript),this._display(),this._addEscBehaviour()}.bind(this),onFailure:function(){$("simple-modal").removeClass("loading"),$("simple-modal").getElement(".contents").set("html","loading failed")}}).send()},_scaleImage:function(t,e){var i=this.options.lightboxExcessHeight+this.options.offsetTop,o=this.options.lightboxExcessWidth,s=t,n=e,a=window.getSize().x-o,d=window.getSize().y-i;return ratio=n>=s?n/d:s/a,ratio=Math.max(ratio,1),t=parseInt(s/ratio),e=parseInt(n/ratio),{width:t,height:e}},_display:function(){try{$("simple-modal-overlay").setStyles({height:window.getCoordinates().height})}catch(t){}try{var e=this.options.offsetTop||40;$("simple-modal").setStyles({top:e,left:(window.getCoordinates().width-$("simple-modal").getCoordinates().width)/2})}catch(t){}},_addEscBehaviour:function(){if(this.options.keyEsc&&(this._removeSM=function(t){"esc"==t.key&&this.hide()}.bind(this),this.options.keyEsc)){window.addEvent("keydown",this._removeSM);var t=$("simple-modal").getElement("iframe");t&&t.addEvent("load",function(){t.contentWindow.MooTools&&t.contentWindow.addEvent("keydown",this._removeSM)}.bind(this))}},_template:function(t,e){for(var i in e)t=t.replace(new RegExp("{"+i+"}","g"),e[i]);return t}});